<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thông báo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
        font-family: 'Roboto', sans-serif;
    }
    .sidebar {
        transition: all 0.3s ease;
    }
    .table-container {
        overflow-x: auto;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .pagination-btn {
        @apply px-3 py-1 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50;
    }
    .pagination-btn.active {
        @apply bg-blue-500 text-white border-blue-500 hover:bg-blue-600;
    }
    .pagination-btn.disabled {
        @apply opacity-50 cursor-not-allowed hover:bg-white;
    }
    .hover-scale {
        transition: transform 0.2s;
    }
    .hover-scale:hover {
        transform: scale(1.02);
    }
  </style>
</head>
<body class="bg-gray-50 font-roboto">
<div class="flex">
  <!-- Sidebar -->
  <div class="sidebar bg-gradient-to-b from-blue-800 to-blue-900 text-white h-screen w-64 fixed left-0 top-0 overflow-y-auto shadow-lg z-40">
    <div class="p-6">
      <h2 class="text-2xl font-bold mb-8 flex items-center">
        <i class="fas fa-hotel mr-3"></i>
        <span>Hotel Manager</span>
      </h2>
      <ul class="space-y-3">
        <li>
          <a th:href="@{/managerRooms}" class="flex items-center p-3 rounded-lg hover:bg-blue-700 transition duration-200">
            <i class="fas fa-door-open w-5 mr-3"></i> Quản lý phòng
          </a>
        </li>
        <li>
          <a th:href="@{/managerBookings}" class="flex items-center p-3 rounded-lg hover:bg-blue-700 transition duration-200">
            <i class="fas fa-calendar-alt w-5 mr-3"></i> Danh sách đặt phòng
          </a>
        </li>
        <li>
          <a th:href="@{/managerHotel/notify}" class="flex items-center p-3 rounded-lg bg-blue-700 shadow-md">
            <i class="fas fa-bell w-5 mr-3"></i> Thông báo
          </a>
        </li>
        <li class="mt-8 pt-6 border-t border-blue-700">
          <a th:href="@{/logout}" class="flex items-center p-3 rounded-lg hover:bg-blue-700 transition duration-200">
            <i class="fas fa-sign-out-alt w-5 mr-3"></i> Đăng xuất
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- Main content -->
  <div class="ml-64 w-full min-h-screen">
    <div class="container mx-auto p-8">
      <!-- Header -->
      <div class="bg-white p-6 rounded-xl shadow-md mb-8 fade-in">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-3xl font-bold text-gray-800">
              <i class="fas fa-bell mr-2 text-blue-500"></i>
              Thông báo
            </h2>
            <p class="text-gray-600 mt-1">Quản lý danh sách thông báo</p>
          </div>
          <div class="bg-blue-50 p-3 rounded-lg">
            <p class="text-sm text-blue-800">
              <i class="fas fa-info-circle mr-1"></i>
              Tổng số thông báo: <strong th:text="${#lists.size(notifications)}"></strong>
            </p>
          </div>
        </div>
      </div>

      <!-- Search and filter -->
      <div class="flex justify-between items-center mb-6">
        <div class="flex items-center space-x-4">
          <div class="relative">
            <input type="text" id="searchInput" placeholder="Tìm kiếm thông báo..."
                   class="pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-64">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
          </div>
        </div>
        <button id="markAllReadBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-200 flex items-center">
          <i class="fas fa-check-double mr-2"></i> Đánh dấu tất cả đã đọc
        </button>
      </div>

      <!-- Notifications Table -->
      <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6 fade-in">
        <div class="table-container">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
            <tr>
              <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nội dung</th>
              <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thời gian</th>
              <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
              <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hành động</th>
            </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="notificationsTableBody">
            <tr th:each="notify : ${notifications}" class="hover:bg-blue-50 transition duration-150">
              <td class="py-4 px-6 text-sm text-gray-700" th:text="${notify.description}"></td>
              <td class="py-4 px-6 text-sm text-gray-700" th:text="${#temporals.format(notify.notify.dateNotify, 'dd/MM/yyyy HH:mm')}"></td>
              <td class="py-4 px-6 text-sm text-center">
                <span th:if="${notify.notify.isRead}" class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">Đã đọc</span>
                <span th:unless="${notify.notify.isRead}" class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">Chưa đọc</span>
              </td>
              <td class="py-4 px-6 text-sm font-medium text-center">
                <div class="flex space-x-3 justify-center">
                  <button th:if="${!notify.notify.isRead}" class="text-blue-600 hover:text-blue-800 hover-scale mark-read-btn"
                          th:data-notify-id="${notify.notify.id}">
                    <i class="fas fa-check"></i> Đánh dấu đã đọc
                  </button>
                  <button class="text-red-600 hover:text-red-800 hover-scale delete-notify-btn"
                          th:data-notify-id="${notify.notify.id}">
                    <i class="fas fa-trash-alt"></i> Xóa
                  </button>
                </div>
              </td>
            </tr>
            <tr th:if="${#lists.isEmpty(notifications)}">
              <td colspan="4" class="py-4 px-6 text-sm text-gray-500 text-center">Không có thông báo nào</td>
            </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
          <div class="text-sm text-gray-500">
            Hiển thị <span id="startItem">1</span> đến <span id="endItem">10</span> trên tổng số <span id="totalItems" th:text="${#lists.size(notifications)}"></span> thông báo
          </div>
          <div class="flex justify-center space-x-1" id="pagination">
            <button id="prevPage" class="pagination-btn disabled">
              <i class="fas fa-chevron-left"></i>
            </button>
            <!-- Pagination buttons will be added dynamically -->
            <button id="nextPage" class="pagination-btn">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl">
    <h3 class="text-xl font-bold mb-4">Xác nhận xóa thông báo</h3>
    <p class="mb-6 text-gray-600">Bạn có chắc chắn muốn xóa thông báo này? Hành động này không thể hoàn tác.</p>
    <div class="flex space-x-3">
      <a id="confirmDeleteBtn" href="#" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg text-center">
        Xóa thông báo
      </a>
      <button id="cancelDeleteBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg">
        Hủy bỏ
      </button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Pagination variables
      const pageSize = 10; // Number of items per page
      let currentPage = 1;
      const totalItems = parseInt(document.getElementById("totalItems").textContent);
      const totalPages = Math.ceil(totalItems / pageSize);

      const paginationContainer = document.getElementById("pagination");
      const prevPageBtn = document.getElementById("prevPage");
      const nextPageBtn = document.getElementById("nextPage");
      const startItemSpan = document.getElementById("startItem");
      const endItemSpan = document.getElementById("endItem");

      // Mark as read functionality
      const markReadButtons = document.querySelectorAll(".mark-read-btn");
      markReadButtons.forEach(button => {
          button.addEventListener("click", function() {
              const notifyId = this.getAttribute("data-notify-id");
              markAsRead(notifyId);
          });
      });

      // Mark all as read
      const markAllReadBtn = document.getElementById("markAllReadBtn");
      if (markAllReadBtn) {
          markAllReadBtn.addEventListener("click", markAllAsRead);
      }

      // Delete notification functionality
      const deleteButtons = document.querySelectorAll(".delete-notify-btn");
      const deleteModal = document.getElementById("deleteModal");
      const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
      const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");

      deleteButtons.forEach(button => {
          button.addEventListener("click", function() {
              const notifyId = this.getAttribute("data-notify-id");
              showDeleteConfirmation(notifyId);
          });
      });

      if (cancelDeleteBtn) {
          cancelDeleteBtn.addEventListener("click", hideDeleteModal);
      }

      // Close modal when clicking outside
      if (deleteModal) {
          deleteModal.addEventListener("click", function(e) {
              if (e.target === deleteModal) {
                  hideDeleteModal();
              }
          });
      }

      // Search functionality
      const searchInput = document.getElementById("searchInput");
      if (searchInput) {
          searchInput.addEventListener("input", filterNotifications);
      }

      // Generate pagination buttons
      function generatePaginationButtons() {
          // Clear existing page buttons (but not prev/next)
          const pageButtons = document.querySelectorAll(".page-button");
          pageButtons.forEach(button => button.remove());

          // Determine which page buttons to show
          let startPage = Math.max(1, currentPage - 2);
          let endPage = Math.min(totalPages, startPage + 4);

          // Adjust when near end
          if (endPage - startPage < 4) {
              startPage = Math.max(1, endPage - 4);
          }

          // Insert page buttons before next button
          for (let i = startPage; i <= endPage; i++) {
              const button = document.createElement("button");
              button.classList.add("pagination-btn", "page-button");
              button.textContent = i;

              if (i === currentPage) {
                  button.classList.add("active");
              }

              button.addEventListener("click", () => {
                  goToPage(i);
              });

              paginationContainer.insertBefore(button, nextPageBtn);
          }
      }

      // Update display to show items for current page
function updateDisplay() {
    const rows = document.querySelectorAll("#notificationsTableBody tr");
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, totalItems);

    // Hide all rows first
    rows.forEach((row, index) => {
        if (index < rows.length - 1 || rows.length > 1) { // Skip the "no notifications" row if it exists and is not the only row
            row.style.display = "none";
        }
    });

    // Show only rows for current page
    let visibleCount = 0;
    rows.forEach((row, index) => {
        if (index >= startIndex && index < endIndex) {
            row.style.display = "";
            visibleCount++;
        }
    });

    // Show "no results" row if no visible items after filtering
    if (visibleCount === 0 && rows.length > 1) {
        const noResultsRow = document.querySelector("#notificationsTableBody tr:last-child");
        if (noResultsRow) {
            noResultsRow.style.display = "";
        }
    }

    // Update displayed item range
    startItemSpan.textContent = totalItems > 0 ? startIndex + 1 : 0;
    endItemSpan.textContent = endIndex;

    // Update prev/next button states
    prevPageBtn.classList.toggle("disabled", currentPage === 1);
    nextPageBtn.classList.toggle("disabled", currentPage === totalPages || totalItems === 0);
}

// Go to specific page
function goToPage(page) {
    currentPage = page;
    updateDisplay();
    generatePaginationButtons();
}

// Previous page handler
prevPageBtn.addEventListener("click", function() {
    if (currentPage > 1) {
        goToPage(currentPage - 1);
    }
});

// Next page handler
nextPageBtn.addEventListener("click", function() {
    if (currentPage < totalPages) {
        goToPage(currentPage + 1);
    }
});

// Filter notifications based on search input
function filterNotifications() {
    const searchTerm = searchInput.value.toLowerCase();
    const rows = document.querySelectorAll("#notificationsTableBody tr");
    let visibleCount = 0;

    rows.forEach((row, index) => {
        if (index < rows.length - 1 || rows.length === 1) { // Skip the "no notifications" row
            const content = row.querySelector("td:first-child").textContent.toLowerCase();
            if (content.includes(searchTerm)) {
                row.style.display = "";
                visibleCount++;
            } else {
                row.style.display = "none";
            }
        }
    });

    // Show or hide "no results" message
    const noResultsRow = rows[rows.length - 1];
    if (rows.length > 1) {
        if (visibleCount === 0) {
            noResultsRow.style.display = "";
            noResultsRow.querySelector("td").textContent = "Không tìm thấy thông báo nào phù hợp";
        } else {
            noResultsRow.style.display = "none";
        }
    }

    // Reset pagination when filtering
    currentPage = 1;
    generatePaginationButtons();
    updateDisplay();
}

// Mark notification as read
function markAsRead(notifyId) {
    fetch(`/api/notifications/${notifyId}/read`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            // Update UI without page refresh
            const row = document.querySelector(`[data-notify-id="${notifyId}"]`).closest('tr');
            const statusCell = row.querySelector('td:nth-child(3)');
            statusCell.innerHTML = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">Đã đọc</span>';

            // Remove mark as read button
            const markReadBtn = row.querySelector('.mark-read-btn');
            if (markReadBtn) markReadBtn.remove();

            // Show success notification
            showNotification('Đã đánh dấu thông báo là đã đọc', 'success');
        } else {
            showNotification('Có lỗi xảy ra. Vui lòng thử lại sau.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Có lỗi xảy ra. Vui lòng thử lại sau.', 'error');
    });
}

// Mark all notifications as read
function markAllAsRead() {
    fetch('/api/notifications/mark-all-read', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            // Update all status cells
            const statusCells = document.querySelectorAll('#notificationsTableBody tr td:nth-child(3)');
            statusCells.forEach(cell => {
                cell.innerHTML = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">Đã đọc</span>';
            });

            // Remove all mark as read buttons
            const markReadBtns = document.querySelectorAll('.mark-read-btn');
            markReadBtns.forEach(btn => btn.remove());

            showNotification('Đã đánh dấu tất cả thông báo là đã đọc', 'success');
        } else {
            showNotification('Có lỗi xảy ra. Vui lòng thử lại sau.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Có lỗi xảy ra. Vui lòng thử lại sau.', 'error');
    });
}

// Delete notification confirmation
function showDeleteConfirmation(notifyId) {
    confirmDeleteBtn.setAttribute('data-notify-id', notifyId);
    confirmDeleteBtn.addEventListener('click', deleteNotification);
    deleteModal.classList.remove('hidden');
}

function hideDeleteModal() {
    deleteModal.classList.add('hidden');
    confirmDeleteBtn.removeEventListener('click', deleteNotification);
}

// Delete notification
function deleteNotification(e) {
    e.preventDefault();
    const notifyId = this.getAttribute('data-notify-id');

    fetch(`/api/notifications/${notifyId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            // Remove the row from table
            const row = document.querySelector(`[data-notify-id="${notifyId}"]`).closest('tr');
            row.remove();

            // Update total count
            const totalItems = document.getElementById("totalItems");
            totalItems.textContent = parseInt(totalItems.textContent) - 1;

            // Check if table is empty
            const tbody = document.getElementById('notificationsTableBody');
            if (tbody.children.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = '<td colspan="4" class="py-4 px-6 text-sm text-gray-500 text-center">Không có thông báo nào</td>';
                tbody.appendChild(emptyRow);
            }

            hideDeleteModal();
            showNotification('Đã xóa thông báo thành công', 'success');

            // Refresh pagination
            generatePaginationButtons();
            updateDisplay();
        } else {
            hideDeleteModal();
            showNotification('Có lỗi xảy ra. Vui lòng thử lại sau.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        hideDeleteModal();
        showNotification('Có lỗi xảy ra. Vui lòng thử lại sau.', 'error');
    });
}

// Toast notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white fade-in z-50 ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' :
        'bg-blue-500'
    }`;

    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${
                type === 'success' ? 'check-circle' :
                type === 'error' ? 'exclamation-circle' :
                'info-circle'
            } mr-2"></i>
            <span>${message}</span>
        </div>
    `;

    document.body.appendChild(notification);

    // Remove notification after 3 seconds
    setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// Initialize
generatePaginationButtons();
updateDisplay();
});
</script>
</body>
</html>